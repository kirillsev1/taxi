<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">

    <style>
		#map {
			height: 400px;
			width: 100%;
		}

    </style>
</head>
{% block content %}
<h1>Taxi Service</h1>
{% if error %}
    <p>error</p>
{% endif %}
<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <div id="map"></div>
    <button type="submit">Submit</button>
</form>

{% endblock %}

<!--  <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>-->
<!--  <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet" />-->
<!--  <script>-->
<!--    mapboxgl.accessToken = 'AIzaSyC_fBdY87ORS_Hq8FQaYSpRahwlvGP3NZE';-->

<script>
    var map, marker1, marker2;
    var isFirstPointSelected = false;

    function initMap() {
        // Try HTML5 geolocation to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var initialLatlng = {lat: position.coords.latitude, lng: position.coords.longitude};
                document.getElementById('departure-input').value = position.coords.latitude + ',' + position.coords.longitude;

                map = new google.maps.Map(document.getElementById('map'), {
                    center: initialLatlng,
                    zoom: 15
                });

                marker1 = new google.maps.Marker({
                    position: initialLatlng,
                    map: map,
                    title: 'Point 1',
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/pink-dot.png'
                    }
                });

                map.addListener('rightclick', function(e) {
                    document.getElementById('departure-input').value = e.latLng.lng() + ',' + e.latLng.lat();
                    marker1.setPosition(e.latLng);
                });

                map.addListener('click', function(e) {
                    document.getElementById('arrival-input').value = e.latLng.lng() + ',' + e.latLng.lat();
                    if (!marker2) {
                        marker2 = new google.maps.Marker({
                            position: e.latLng,
                            map: map,
                            title: 'Point 2'
                        });
                    } else {
                        marker2.setPosition(e.latLng);
                    }
                    // Set the form fields to the new coordinates
                    var coordinates1Field = document.getElementById('departure-input');
                    var coordinates2Field = document.getElementById('arrival-input');
                    coordinates1Field.value = marker1.getPosition().lng() + ',' + marker1.getPosition().lat();
                    coordinates2Field.value = marker2.getPosition().lng() + ',' + marker2.getPosition().lat();

                });
                const trafficLayer = new google.maps.TrafficLayer();
                trafficLayer.setMap(map);
            }, function() {
                // Handle geolocation error
                alert('Error: The Geolocation service failed.');
            });
        } else {
            // Browser doesn't support Geolocation
            alert('Error: Your browser doesn\'t support geolocation.');
        }
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_fBdY87ORS_Hq8FQaYSpRahwlvGP3NZE&callback=initMap"
        async defer></script>